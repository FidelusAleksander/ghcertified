name: Preview Deploy (Trusted)

on:
  workflow_run:
    workflows: ["Preview Build (Untrusted)"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy:
    name: Deploy to Cloudflare Pages
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ toJson(github.event.workflow_run.pull_requests) }}" == "[]" ]; then
            echo "No pull request associated with this workflow run"
            exit 1
          fi
          PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR Number: $PR_NUMBER"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: hugo-build-${{ steps.pr.outputs.number }}
          path: public/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Deploy to Cloudflare Pages
        id: deploy
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy public/ --project-name=${{ vars.CLOUDFLARE_PROJECT_NAME }}

      - name: Create comment
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.pr.outputs.number }}
          body: |
            **âœ… Preview Environment Ready!**

            | Name | Link |
            | --- | --- |
            | :link: Preview URL | ${{ steps.deploy.outputs.pages-deployment-alias-url || steps.deploy.outputs.deployment-url }} |

            Please verify everything looks as expected.

          reactions: rocket

      - name: Remove Label
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = ${{ steps.pr.outputs.number }};
            const labelToRemove = 'request-preview-deployment';
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                name: labelToRemove
              });
            } catch (error) {
              // Label might already be removed, ignore error
              console.log('Label removal failed:', error.message);
            }
